# ğŸ—ï¸ MiniSwap â€” ê¸°ìˆ  ì•„í‚¤í…ì²˜

---

## ì „ì²´ êµ¬ì¡° ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ì‚¬ìš©ì ë¸Œë¼ìš°ì €                        â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   React UI   â”‚   â”‚  Trystero    â”‚   â”‚  IndexedDB   â”‚ â”‚
â”‚  â”‚  (ëª¨ë°”ì¼ ì•±)  â”‚   â”‚ (P2P ì˜¤ë”ë¶) â”‚   â”‚ (ë¡œì»¬ ì €ì¥ì†Œ) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                  â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              ethers.js / wagmi                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                MetaMask (ì§€ê°‘)                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ JSON-RPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Arbitrum One                           â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           MiniSwapEscrow.sol                        â”‚  â”‚
â”‚  â”‚  deposit() / release() / refund() / dispute()       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  USDT Token  â”‚           â”‚   2-of-2 MultisigAdmin   â”‚ â”‚
â”‚  â”‚   (ERC-20)   â”‚           â”‚   (ë¶„ìŸ ì¤‘ì¬ìš©)           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ê¸°ìˆ  ìŠ¤íƒ

| ë ˆì´ì–´ | ê¸°ìˆ  | ì—­í•  |
|--------|------|------|
| **ë¸”ë¡ì²´ì¸** | Arbitrum One | ì €ë ´í•œ Gas (~$0.15/tx) |
| **ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸** | Solidity ^0.8.x | ì—ìŠ¤í¬ë¡œ ë¡œì§ |
| **ì§€ê°‘ ì—°ë™** | MetaMask + ethers.js | íŠ¸ëœì­ì…˜ ì„œëª… |
| **P2P ë„¤íŠ¸ì›Œí‚¹** | Trystero (WebRTC) | ì˜¤ë”ë¶ ë¸Œë¡œë“œìºìŠ¤íŠ¸ |
| **ë¡œì»¬ ì €ì¥ì†Œ** | IndexedDB | ì˜¤ë”Â·ê±°ë˜ë‚´ì—­ ì €ì¥ |
| **í”„ë¡ íŠ¸ì—”ë“œ** | React (ëª¨ë°”ì¼ í¼ìŠ¤íŠ¸) | UI/UX |
| **ì„œë²„** | ì—†ìŒ (Serverless) | â€” |

---

## ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ì„¤ê³„

### MiniSwapEscrow.sol

```solidity
struct Trade {
    address seller;      // íŒë§¤ì ì£¼ì†Œ
    address buyer;       // êµ¬ë§¤ì ì£¼ì†Œ
    uint256 amount;      // USDT ê¸ˆì•¡
    uint256 feeAmount;   // ìˆ˜ìˆ˜ë£Œ (2%)
    uint256 createdAt;   // ìƒì„± ì‹œê°„
    uint256 expiresAt;   // ë§Œë£Œ ì‹œê°„ (7ì¼)
    TradeStatus status;  // LOCKED / RELEASED / DISPUTED / REFUNDED
}

enum TradeStatus { LOCKED, RELEASED, DISPUTED, REFUNDED }

// í•µì‹¬ í•¨ìˆ˜
function deposit(address buyer, uint256 amount) external;   // ì—ìŠ¤í¬ë¡œ ë½
function release(bytes32 tradeId) external;                  // KRW í™•ì¸ í›„ ë¦´ë¦¬ì¦ˆ
function refund(bytes32 tradeId) external;                   // íƒ€ì„ì•„ì›ƒ í™˜ë¶ˆ
function dispute(bytes32 tradeId) external;                  // ë¶„ìŸ ì‹ ì²­
function adminResolve(bytes32 tradeId, bool toSeller) external; // ì¤‘ì¬ íŒì •
```

### ì—ìŠ¤í¬ë¡œ ìƒíƒœ íë¦„

```
deposit()
    â”‚
    â–¼
 LOCKED â”€â”€â”€â”€ release() â”€â”€â”€â”€â”€â”€â–º RELEASED (ì •ìƒ ì™„ë£Œ)
    â”‚
    â”œâ”€â”€â”€â”€ dispute() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º DISPUTED
    â”‚                               â”‚
    â”‚                         adminResolve()
    â”‚                               â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â–¼                     â–¼
    â”‚                 toSeller=true        toSeller=false
    â”‚                (íŒë§¤ì ìŠ¹ë¦¬)          (êµ¬ë§¤ì ìŠ¹ë¦¬)
    â”‚
    â””â”€â”€â”€â”€ refund() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º REFUNDED (7ì¼ íƒ€ì„ì•„ì›ƒ)
```

### Gas ìµœì í™” ì „ëµ

```
ì˜¤ë” ì˜¬ë¦¬ê¸°: Gas ì—†ìŒ
  â†’ Trystero P2P ë©”ì‹œì§€ë¡œ ë¸Œë¡œë“œìºìŠ¤íŠ¸
  â†’ IndexedDBì— ë¡œì»¬ ì €ì¥

ì—ìŠ¤í¬ë¡œ ë½ (deposit): ~$0.10~0.15
  â†’ ERC-20 approve + deposit 2ë²ˆ íŠ¸ëœì­ì…˜
  â†’ approveëŠ” max uint256ìœ¼ë¡œ 1íšŒ ì²˜ë¦¬ ê°€ëŠ¥

ë¦´ë¦¬ì¦ˆ (release): ~$0.05
  â†’ íŒë§¤ìê°€ ì„œëª…, 1ë²ˆ íŠ¸ëœì­ì…˜
```

---

## P2P ì˜¤ë”ë¶ ì•„í‚¤í…ì²˜ (Trystero)

### ì˜¤ë” íƒ€ì…

```typescript
// íŒë§¤ ì˜¤ë”
type SellOrder = {
  id: string;
  type: 'SELL';
  seller: string;       // 0x ì£¼ì†Œ
  amount: number;       // USDT ìˆ˜ëŸ‰
  priceKRW: number;     // KRW/USDT í™˜ìœ¨
  bankAccount: string;  // ì…ê¸ˆ ê³„ì¢Œ (ì•”í˜¸í™”)
  expiry: number;       // Unix timestamp
  signature: string;    // MetaMask ì„œëª…
}

// êµ¬ë§¤ ì˜¤ë”
type BuyOrder = {
  id: string;
  type: 'BUY';
  buyer: string;        // 0x ì£¼ì†Œ
  amount: number;       // ì›í•˜ëŠ” USDT ìˆ˜ëŸ‰
  priceKRW: number;     // KRW/USDT í™˜ìœ¨
  expiry: number;
  signature: string;
}
```

### Trystero ì±„ë„ êµ¬ì¡°

```
Room: "miniswap-orderbook-mainnet"
  â”œâ”€â”€ Channel: "sell-orders"   â†’ íŒë§¤ ì˜¤ë” ë¸Œë¡œë“œìºìŠ¤íŠ¸
  â”œâ”€â”€ Channel: "buy-orders"    â†’ êµ¬ë§¤ ì˜¤ë” ë¸Œë¡œë“œìºìŠ¤íŠ¸
  â”œâ”€â”€ Channel: "accept-req"    â†’ ìˆ˜ë½ ìš”ì²­ (êµ¬ë§¤ì â†’ íŒë§¤ì)
  â””â”€â”€ Channel: "accept-res"    â†’ ìˆ˜ë½ ì‘ë‹µ (íŒë§¤ì â†’ êµ¬ë§¤ì)
```

### Race Condition í•´ê²°

```
êµ¬ë§¤ì A, B, C ë™ì‹œ ìˆ˜ë½ ìš”ì²­
         â”‚
         â–¼
íŒë§¤ìì—ê²Œ accept-req ìˆ˜ì‹  (íƒ€ì„ìŠ¤íƒ¬í”„ í¬í•¨)
         â”‚
         â–¼
íŒë§¤ìê°€ UIì—ì„œ 1ëª… ì„ íƒ (ëª…ì‹œì  ì„ íƒ)
         â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
  â–¼             â–¼
ì„ íƒëœ A     B, Cì—ê²Œ reject ë©”ì‹œì§€
ì—ìŠ¤í¬ë¡œ ë½    (P2P ì±„ë„ë¡œ ìë™ ì „ì†¡)
```

---

## ê±°ë˜ í”Œë¡œìš° ìƒì„¸

### í”Œë¡œìš° A: íŒë§¤ ì˜¤ë” ìˆ˜ë½

```
íŒë§¤ì                                êµ¬ë§¤ì
â”€â”€â”€â”€â”€                                â”€â”€â”€â”€â”€
S06: ì˜¤ë” ì‘ì„±
  â”‚
  â””â”€â”€ P2P ë¸Œë¡œë“œìºìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º S03: ì˜¤ë”ë¶ì— í‘œì‹œ
                                      S11: ì˜¤ë” ìƒì„¸ í™•ì¸
                                      S11: ìˆ˜ë½ ìš”ì²­ ì „ì†¡
  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
S07: ìˆ˜ë½ ìš”ì²­ ìˆ˜ì‹  (ì—¬ëŸ¬ ëª… ê°€ëŠ¥)
S07: êµ¬ë§¤ì 1ëª… ì„ íƒ
  â”‚
S08: MetaMask íŒì—… Ã—2
  â”œâ”€â”€ approve(escrow, amount)
  â””â”€â”€ deposit(buyer, amount)
                                     S12: ì—ìŠ¤í¬ë¡œ í™•ì¸
                                          (Arbitrum TX ê²€ì¦)
                                     S13: ê³„ì¢Œ í™•ì¸ í›„ KRW ì†¡ê¸ˆ
S09: KRW ì…ê¸ˆ í™•ì¸
  â””â”€â”€ release(tradeId)               S14: USDT ìˆ˜ë ¹ + í‰ì 
S10: íŒë§¤ ì™„ë£Œ + í‰ì 
```

### í”Œë¡œìš° B: êµ¬ë§¤ ì˜¤ë” ìˆ˜ë½

```
êµ¬ë§¤ì                                íŒë§¤ì
â”€â”€â”€â”€â”€                                â”€â”€â”€â”€â”€
S15: êµ¬ë§¤ ì˜¤ë” ì‘ì„±
  â”‚
  â””â”€â”€ P2P ë¸Œë¡œë“œìºìŠ¤íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º S04: ì˜¤ë”ë¶ì— í‘œì‹œ
S16: ëŒ€ê¸° ì¤‘                          S17: êµ¬ë§¤ì˜¤ë” ìƒì„¸ í™•ì¸
                                      S18: ìˆ˜ë½ í´ë¦­
                                        â””â”€â”€ MetaMask Ã—2
                                              approve + deposit
  â—„â”€ ì•Œë¦¼ + ê³„ì¢Œ ê³µê°œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
S13: KRW ì†¡ê¸ˆ
S14: ì™„ë£Œ + í‰ì                       S09: KRW í™•ì¸ â†’ release
                                      S10: ì™„ë£Œ + í‰ì 
```

**í”Œë¡œìš° A vs B ë¹„êµ**

| í•­ëª© | í”Œë¡œìš° A | í”Œë¡œìš° B |
|------|---------|---------|
| ì˜¤ë” ê²Œì‹œì | íŒë§¤ì | êµ¬ë§¤ì |
| ì—ìŠ¤í¬ë¡œ ë½ ì£¼ì²´ | íŒë§¤ì (ìˆ˜ë½ í›„) | íŒë§¤ì (ìˆ˜ë½ ì¦‰ì‹œ) |
| êµ¬ë§¤ì ì„ íƒ ë‹¨ê³„ | ìˆìŒ (S07) | ì—†ìŒ |
| ì´ ë‹¨ê³„ ìˆ˜ | íŒë§¤ì 5ë‹¨ê³„ | íŒë§¤ì 4ë‹¨ê³„ |
| íŠ¹ì§• | ì—¬ëŸ¬ êµ¬ë§¤ì ì¤‘ ì„ íƒ ê°€ëŠ¥ | 1:1 ì¦‰ì‹œ ë§¤ì¹­ |

---

## ë¡œì»¬ ë°ì´í„° ì €ì¥ (IndexedDB)

```typescript
// DB ìŠ¤í‚¤ë§ˆ
const DB_SCHEMA = {
  orders: {
    keyPath: 'id',
    indexes: ['type', 'seller', 'buyer', 'status', 'expiry']
  },
  trades: {
    keyPath: 'tradeId',
    indexes: ['seller', 'buyer', 'status', 'createdAt']
  },
  settings: {
    keyPath: 'key'
    // 'bankAccount', 'nickname' ë“±
  }
}
```

**ì €ì¥ ì›ì¹™**: ë¯¼ê° ì •ë³´(ê³„ì¢Œë²ˆí˜¸)ëŠ” ë¡œì»¬ë§Œ ì €ì¥, ì„œë²„ ì „ì†¡ ì—†ìŒ

---

## MetaMask ì—°ë™

### ì§€ê°‘ ì—°ê²°

```javascript
// 1. ì—°ê²°
const provider = new ethers.BrowserProvider(window.ethereum);
await provider.send("eth_requestAccounts", []);

// 2. ë„¤íŠ¸ì›Œí¬ í™•ì¸
const network = await provider.getNetwork();
if (network.chainId !== 42161n) {
  // Arbitrum chainId = 42161
  await window.ethereum.request({
    method: 'wallet_switchEthereumChain',
    params: [{ chainId: '0xa4b1' }]
  });
}

// 3. ì„œëª…ì íšë“
const signer = await provider.getSigner();
const address = await signer.getAddress(); // ì´ê²Œ ê³§ ì‚¬ìš©ì ì‹ ì›
```

### ì—ìŠ¤í¬ë¡œ íŠ¸ëœì­ì…˜

```javascript
// approve
const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
await usdt.approve(ESCROW_ADDRESS, amount);

// deposit
const escrow = new ethers.Contract(ESCROW_ADDRESS, ESCROW_ABI, signer);
await escrow.deposit(buyerAddress, amount);

// release (íŒë§¤ìê°€ KRW í™•ì¸ í›„ ì„œëª…)
await escrow.release(tradeId);
```

---

## ì˜¤ë” ì„œëª… ê²€ì¦

P2Pë¡œ ì „ë‹¬ëœ ì˜¤ë”ì˜ ìœ„ë³€ì¡° ë°©ì§€:

```javascript
// ì˜¤ë” ì„œëª… (ì˜¤ë” ì‘ì„± ì‹œ)
const messageHash = ethers.solidityPackedKeccak256(
  ['string', 'uint256', 'uint256', 'uint256'],
  [orderId, amount, priceKRW, expiry]
);
const signature = await signer.signMessage(ethers.getBytes(messageHash));

// ì„œëª… ê²€ì¦ (ì˜¤ë” ìˆ˜ì‹  ì‹œ)
const recovered = ethers.verifyMessage(ethers.getBytes(messageHash), signature);
if (recovered.toLowerCase() !== order.seller.toLowerCase()) {
  // ìœ„ì¡°ëœ ì˜¤ë” â†’ ë¬´ì‹œ
}
```

---

## í‰ì  ì‹œìŠ¤í…œ

```
ê±°ë˜ ì™„ë£Œ í›„ ì–‘ë°©í–¥ í‰ì 
  â”œâ”€â”€ íŒë§¤ì â†’ êµ¬ë§¤ì í‰ì  (1~5ì )
  â””â”€â”€ êµ¬ë§¤ì â†’ íŒë§¤ì í‰ì  (1~5ì )

ì €ì¥ ìœ„ì¹˜: IndexedDB (ë¡œì»¬)
ì§‘ê³„ ë°©ì‹: ìˆ˜ì‹ í•œ ëª¨ë“  í‰ì ì˜ í‰ê· 
í‘œì‹œ í˜•íƒœ: â˜… 4.9 Â· ê±°ë˜ 127íšŒ

íŒ¨ë„í‹°:
  â””â”€â”€ 10ë¶„ ë‚´ ì—ìŠ¤í¬ë¡œ ë½ ë¯¸ì™„ë£Œ ì‹œ â†’ ìë™ -1ì 
```

---

## ë¶„ìŸ í•´ê²°

```
ë¶„ìŸ ì‹ ì²­ (S19)
  â”‚
  â”œâ”€â”€ ìë™ ìˆ˜ì§‘ ì¦ê±°
  â”‚     â”œâ”€â”€ ì˜¤ë” ë°ì´í„° (íŒë§¤ì ì„œëª… í¬í•¨)
  â”‚     â”œâ”€â”€ P2P ì±„íŒ… ë‚´ì—­
  â”‚     â””â”€â”€ Arbitrum ì—ìŠ¤í¬ë¡œ TX
  â”‚
  â”œâ”€â”€ ì‚¬ìš©ì ì œì¶œ ì¦ê±°
  â”‚     â””â”€â”€ ì†¡ê¸ˆ í™•ì¸ì¦ ìº¡ì²˜ (ì„ íƒ)
  â”‚
  â””â”€â”€ ìš´ì˜ì 2ëª… ê²€í†  (24~48ì‹œê°„)
        â”‚
        â”œâ”€â”€ íŒë§¤ì ìŠ¹ë¦¬ â†’ release(toSeller=true)
        â””â”€â”€ êµ¬ë§¤ì ìŠ¹ë¦¬ â†’ release(toSeller=false)
```

---

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

| ìœ„í˜‘ | ëŒ€ì‘ |
|------|------|
| ì˜¤ë” ìœ„ë³€ì¡° | MetaMask ì„œëª… ê²€ì¦ |
| Race Condition | íŒë§¤ì ëª…ì‹œì  ì„ íƒ |
| ë¦´ë¦¬ì¦ˆ ê°•ì œ | ì—ìŠ¤í¬ë¡œ ì»¨íŠ¸ë™íŠ¸ (íŒë§¤ìë§Œ í˜¸ì¶œ ê°€ëŠ¥) |
| ì˜ëª»ëœ ê¸ˆì•¡ ì…ë ¥ | ë³µì‚¬ ë²„íŠ¼ + ê°•ì œ ì²´í¬ë°•ìŠ¤ |
| ì˜ëª»ëœ ê³„ì¢Œ ì…ë ¥ | ë³µì‚¬ ë²„íŠ¼ + í™•ì¸ ì²´í¬ë°•ìŠ¤ |
| ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ | ìë™ ì²´ì¸ ì „í™˜ (wallet_switchEthereumChain) |
| íƒ€ì„ì•„ì›ƒ ë¯¸ì²˜ë¦¬ | 7ì¼ í›„ ìë™ refund() |

---

## íŒŒì¼ êµ¬ì¡° (Phase 5 ì´í›„ ìµœì¢…)

```
p2pusdt/
â”œâ”€â”€ contracts/
â”‚   â”œâ”€â”€ MiniSwapEscrow.sol          ì—ìŠ¤í¬ë¡œ ì»¨íŠ¸ë™íŠ¸
â”‚   â””â”€â”€ test/MockERC20.sol          í…ŒìŠ¤íŠ¸ í† í°
â”œâ”€â”€ test/
â”‚   â””â”€â”€ MiniSwapEscrow.test.js      66 í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.jsx                     ë£¨íŠ¸ (ë¼ìš°íŒ… + ìƒíƒœ ê´€ë¦¬, 207ì¤„)
â”‚   â”œâ”€â”€ constants.js                ABI, TradeStatus enum, USDT ì£¼ì†Œ
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â””â”€â”€ network.js              Arbitrum ì²´ì¸ ID, RPC, ì§€ì› ì²´ì¸
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ AppShell.jsx            ë ˆì´ì•„ì›ƒ ì…¸ (í—¤ë” + ë„¤íŠ¸ì›Œí¬ ë°°ë„ˆ + í•˜ë‹¨ ë„¤ë¹„)
â”‚   â”‚   â”œâ”€â”€ HeroSection.jsx         ëœë”© í˜ì´ì§€ (ì§€ê°‘ ë¯¸ì—°ê²°)
â”‚   â”‚   â”œâ”€â”€ NetworkGuide.jsx        Arbitrum ë„¤íŠ¸ì›Œí¬ ì „í™˜ ê°€ì´ë“œ
â”‚   â”‚   â”œâ”€â”€ TradeRoom.jsx           ê±°ë˜ ì§„í–‰ í™”ë©´ (ì—ìŠ¤í¬ë¡œ + ì±„íŒ…, 872ì¤„)
â”‚   â”‚   â”œâ”€â”€ TradeTimeline.jsx       5ë‹¨ê³„ ê±°ë˜ íƒ€ì„ë¼ì¸
â”‚   â”‚   â”œâ”€â”€ EscrowBadge.jsx         ì—ìŠ¤í¬ë¡œ ë³´í˜¸ ìƒíƒœ ë°°ì§€
â”‚   â”‚   â”œâ”€â”€ OrderbookView.jsx       ì˜¤ë”ë¶ í—ˆë¸Œ (ë§¤ë„/ë§¤ìˆ˜/ë‚´ ì˜¤ë”)
â”‚   â”‚   â”œâ”€â”€ OrderDetail.jsx         ì˜¤ë” ìƒì„¸ + ìˆ˜ë½ ìš”ì²­
â”‚   â”‚   â”œâ”€â”€ SellOrderForm.jsx       ë§¤ë„ ì˜¤ë” ìƒì„± í¼
â”‚   â”‚   â”œâ”€â”€ BuyOrderForm.jsx        ë§¤ìˆ˜ ì˜¤ë” ìƒì„± í¼
â”‚   â”‚   â”œâ”€â”€ BuyerSelector.jsx       êµ¬ë§¤ì ì„ íƒ (íŒë§¤ì ì „ìš©)
â”‚   â”‚   â”œâ”€â”€ CreateTrade.jsx         ì—ìŠ¤í¬ë¡œ ìƒì„± (approve + deposit)
â”‚   â”‚   â”œâ”€â”€ JoinTrade.jsx           ê±°ë˜ ì°¸ì—¬ (tradeId ê²€ì¦)
â”‚   â”‚   â”œâ”€â”€ TradeHistory.jsx        ê±°ë˜ ë‚´ì—­ (IndexedDB + ì˜¨ì²´ì¸)
â”‚   â”‚   â”œâ”€â”€ OnboardBanner.jsx       ì‹ ê·œ ì‚¬ìš©ì ì˜¨ë³´ë”© ë°°ë„ˆ
â”‚   â”‚   â”œâ”€â”€ WalletButton.jsx        ì§€ê°‘ ì—°ê²°/í•´ì œ ë²„íŠ¼
â”‚   â”‚   â””â”€â”€ ui/                     shadcn/ui ìŠ¤íƒ€ì¼ ê¸°ë³¸ ì»´í¬ë„ŒíŠ¸
â”‚   â”‚       â”œâ”€â”€ button.jsx
â”‚   â”‚       â”œâ”€â”€ card.jsx
â”‚   â”‚       â”œâ”€â”€ badge.jsx
â”‚   â”‚       â”œâ”€â”€ banner.jsx
â”‚   â”‚       â”œâ”€â”€ stepper.jsx
â”‚   â”‚       â”œâ”€â”€ input.jsx
â”‚   â”‚       â”œâ”€â”€ tabs.jsx
â”‚   â”‚       â”œâ”€â”€ dialog.jsx
â”‚   â”‚       â”œâ”€â”€ alert.jsx
â”‚   â”‚       â”œâ”€â”€ separator.jsx
â”‚   â”‚       â”œâ”€â”€ toast.jsx
â”‚   â”‚       â””â”€â”€ avatar.jsx
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAppRouter.js         view ë¬¸ìì—´ ê²°ì •
â”‚   â”‚   â”œâ”€â”€ useTradeStateMachine.js  7ê°œ UX ìƒíƒœ + ì‹œê·¸ë„ ê¸°ë°˜ ì „ì´
â”‚   â”‚   â”œâ”€â”€ useTradeEvents.js       ì´ë²¤íŠ¸ ì¤‘ê³„ + êµ¬ë§¤ì ìë™ ì´ë™
â”‚   â”‚   â”œâ”€â”€ useNetworkSwitch.js     MetaMask ë„¤íŠ¸ì›Œí¬ ì „í™˜
â”‚   â”‚   â”œâ”€â”€ useEscrow.js            ìŠ¤ë§ˆíŠ¸ ì»¨íŠ¸ë™íŠ¸ ì½ê¸°/ì“°ê¸° í›…
â”‚   â”‚   â”œâ”€â”€ useOrderbook.js         Trystero P2P ì˜¤ë”ë¶
â”‚   â”‚   â””â”€â”€ useXmtpChat.js          XMTP 1:1 ì±„íŒ…
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â”œâ”€â”€ XmtpContext.jsx         XMTP í´ë¼ì´ì–¸íŠ¸ ì œê³µ
â”‚   â”‚   â””â”€â”€ ToastContext.jsx        í† ìŠ¤íŠ¸ ì•Œë¦¼ ì œê³µ
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ utils.js                cn() (clsx + twMerge)
â”‚       â””â”€â”€ indexeddb.js            ê±°ë˜ ë°ì´í„° ë¡œì»¬ ì €ì¥ì†Œ
â”œâ”€â”€ architecture.md
â””â”€â”€ hardhat.config.cjs
```

---

## Phase 1-5 ë¦¬ë¹Œë”© â€” ìµœì¢… ì»´í¬ë„ŒíŠ¸ íŠ¸ë¦¬

```
<WagmiProvider>
 <QueryClientProvider>
  <XmtpProvider>
   <ToastProvider>
    <App>
     â”œâ”€â”€ useAppRouter()          â†’ view ê²°ì •
     â”œâ”€â”€ useTradeStateMachine()  â†’ (TradeRoomì—ì„œ ì‚¬ìš©)
     â”œâ”€â”€ useTradeEvents()        â†’ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
     â”œâ”€â”€ useNetworkSwitch()      â†’ ë„¤íŠ¸ì›Œí¬ ì „í™˜
     â”œâ”€â”€ useOrderbook()          â†’ P2P ì˜¤ë”ë¶
     â”‚
     â””â”€â”€ <AppShell showHeader showBottomNav ...>
          â”œâ”€â”€ [Header]   ë¡œê³  + WalletButton
          â”œâ”€â”€ [Banner]   ë„¤íŠ¸ì›Œí¬ ê²½ê³  (wrongNetwork)
          â”‚
          â”œâ”€â”€ renderContent(view) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          â”‚   â”œâ”€â”€ 'loading'      â†’ ìŠ¤í”¼ë„ˆ
          â”‚   â”œâ”€â”€ 'hero'         â†’ <HeroSection />
          â”‚   â”œâ”€â”€ 'network'      â†’ <NetworkGuide />
          â”‚   â”œâ”€â”€ 'trade-room'   â†’ <TradeRoom>
          â”‚   â”‚                       â”œâ”€â”€ <TradeTimeline /> (5ë‹¨ê³„)
          â”‚   â”‚                       â”œâ”€â”€ <EscrowBadge />
          â”‚   â”‚                       â”œâ”€â”€ ì—ìŠ¤í¬ë¡œ ì¹´ë“œ
          â”‚   â”‚                       â”œâ”€â”€ P2P ì±„íŒ… (XMTP)
          â”‚   â”‚                       â””â”€â”€ ì•¡ì…˜ ë²„íŠ¼
          â”‚   â”œâ”€â”€ 'create-trade' â†’ <CreateTrade />
          â”‚   â””â”€â”€ 'home'         â†’ <OnboardBanner />
          â”‚                        + <OrderbookView /> | <TradeHistory />
          â”‚
          â””â”€â”€ [BottomNav]  í™ˆ / ë‚´ ì˜¤ë” / ê±°ë˜ë‚´ì—­ (homeë§Œ)
     </AppShell>
    </App>
   </ToastProvider>
  </XmtpProvider>
 </QueryClientProvider>
</WagmiProvider>
```

---

## ë¼ìš°íŒ… êµ¬ì¡° (useAppRouter)

```
wagmi status === 'reconnecting'  â”€â”€> 'loading'
!isConnected                     â”€â”€> 'hero'
wrongNetwork                     â”€â”€> 'network'
activeTrade?.tradeId             â”€â”€> 'trade-room'
createTradeOptions               â”€â”€> 'create-trade'
(ê¸°ë³¸)                           â”€â”€> 'home'
```

**view ê¸°ë°˜ ë ˆì´ì•„ì›ƒ ì œì–´ ê°ì²´**

| view | showHeader | showBottomNav |
|------|:----------:|:-------------:|
| loading | O | X |
| hero | O | X |
| network | O | X |
| trade-room | O | X |
| create-trade | O | X |
| home | O | **O** |

---

## ê±°ë˜ ìƒíƒœ ë¨¸ì‹  (useTradeStateMachine)

### ì˜¨ì²´ì¸ â†’ UX ìƒíƒœ ë§¤í•‘

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì˜¨ì²´ì¸ TradeStatus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                           â”‚
â”‚  LOCKED(0) â”€â”€â”€ release() â”€â”€â–º RELEASED(1)                 â”‚
â”‚     â”‚                                                     â”‚
â”‚     â”œâ”€â”€ dispute() â”€â”€â–º DISPUTED(2) â”€â”€ adminResolve() â”€â”€â–º  â”‚
â”‚     â”‚                     â”‚                               â”‚
â”‚     â”‚                     â””â”€â”€ forceRefund(30d) â”€â”€â–º        â”‚
â”‚     â”‚                                                     â”‚
â”‚     â””â”€â”€ refund(7d) â”€â”€â–º REFUNDED(3)                       â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼  useTradeStateMachine ë³€í™˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ UX TradeState (7ë‹¨ê³„) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                            â”‚
â”‚  AWAITING_ESCROW â”€â”€â–º ESCROW_LOCKED â”€â”€â–º KRW_SENT           â”‚
â”‚   (trade ë¯¸ìˆ˜ì‹ )     (LOCKED,          (LOCKED,            â”‚
â”‚                       ì‹œê·¸ë„ ì—†ìŒ)       êµ¬ë§¤ì ì‹œê·¸ë„)      â”‚
â”‚                                            â”‚               â”‚
â”‚                                            â–¼               â”‚
â”‚                                       CONFIRMING           â”‚
â”‚                                      (LOCKED,              â”‚
â”‚                                       íŒë§¤ì í™•ì¸)          â”‚
â”‚                                            â”‚               â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚
â”‚                           â–¼                â–¼               â”‚
â”‚                      COMPLETED        REFUNDED             â”‚
â”‚                     (RELEASED)       (REFUNDED)            â”‚
â”‚                                                            â”‚
â”‚  ë¶„ê¸°: LOCKED â†’ dispute() â†’ DISPUTED                      â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### TradeTimeline 5ë‹¨ê³„ ë§¤í•‘

```
 [0]           [1]           [2]            [3]           [4]
  O â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ O â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ O â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ O â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ O
  â”‚             â”‚             â”‚              â”‚             â”‚
 Lock      ShieldCheck  ArrowLeftRight  SearchCheck    CheckCheck
ì—ìŠ¤í¬ë¡œ     USDT         KRW            ì…ê¸ˆ           ê±°ë˜
 ìƒì„±        ì ê¸ˆ          ì†¡ê¸ˆ           í™•ì¸           ì™„ë£Œ
```

| stepIndex | TradeState | ìƒ‰ìƒ | ì• ë‹ˆë©”ì´ì…˜ |
|:---------:|-----------|------|:---------:|
| 0 | AWAITING_ESCROW | primary (blue) | pulse |
| 1 | ESCROW_LOCKED | primary (blue) | pulse |
| 2 | KRW_SENT | primary (blue) | pulse |
| 2 | DISPUTED | destructive (red) | pulse |
| 3 | CONFIRMING | primary (blue) | pulse |
| 4 | COMPLETED | success (green) | - |
| 4 | REFUNDED | info (blue) | - |

### EscrowBadge ìƒíƒœë³„ í‘œì‹œ

| TradeStatus | í…ìŠ¤íŠ¸ | ì•„ì´ì½˜ | ìƒ‰ìƒ | ì• ë‹ˆë©”ì´ì…˜ |
|-------------|--------|--------|------|:---------:|
| LOCKED | ì—ìŠ¤í¬ë¡œ ë³´í˜¸ ì¤‘ | Shield | emerald | pulse |
| RELEASED | ê±°ë˜ ì™„ë£Œ | ShieldCheck | emerald | - |
| REFUNDED | í™˜ë¶ˆ ì™„ë£Œ | Undo2 | blue | - |
| DISPUTED | ë¶„ìŸ ê²€í†  ì¤‘ | ShieldAlert | red | - |

---

## Phase 1-5 ë³€ê²½ ì´ë ¥

| Phase | ì‘ì—… | ìƒì„± íŒŒì¼ | App.jsx |
|:-----:|------|----------|:-------:|
| 1 | HeroSection ë¶„ë¦¬ | HeroSection.jsx | 402â†’328 |
| 2 | ë„¤íŠ¸ì›Œí¬ ë¡œì§ í†µí•© | constants/network.js, useNetworkSwitch.js | 328â†’280 |
| 3 | ë¼ìš°íŒ… ë¦¬íŒ©í† ë§ | useAppRouter.js | 280â†’276 |
| 4 | AppShell + ì´ë²¤íŠ¸ ë¶„ë¦¬ | AppShell.jsx, useTradeEvents.js | 276â†’207 |
| 5 | ìƒíƒœ ë¨¸ì‹  + ì‹ ë¢° UX | useTradeStateMachine.js, TradeTimeline.jsx, EscrowBadge.jsx | 207 |

**App.jsx: 402 â†’ 207ì¤„ (48.5% ì¶•ì†Œ)**
**TradeRoom.jsx: 912 â†’ 872ì¤„ (40ì¤„ ê°ì†Œ)**
